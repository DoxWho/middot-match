<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Middah Mindreader v3.5 | Facilitator Edition</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<style>
  :root {
    --bg-gradient: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    --glass: rgba(255, 255, 255, 0.7);
    --glass-border: rgba(255, 255, 255, 0.4);
    --primary: #0f172a;
    --accent: #6366f1;
    --danger: #f43f5e;
    --success: #10b981;
    --gold: #f59e0b;
  }

  @media print {
    body * { visibility: hidden; }
    #printSection, #printSection * { visibility: visible; }
    #printSection { 
        position: absolute; left: 0; top: 0; width: 100%; 
        display: grid !important; grid-template-columns: repeat(3, 1fr); gap: 10px;
        padding: 20px;
    }
    .printable-card {
        border: 1px solid #ddd; height: 320px; border-radius: 12px;
        display: flex; flex-direction: column; overflow: hidden; page-break-inside: avoid;
        break-inside: avoid; margin-bottom: 10px;
    }
    .p-header { color: white; padding: 10px; text-align: center; font-weight: 800; font-size: 0.8rem; -webkit-print-color-adjust: exact; }
    .p-body { flex: 1; display: flex; flex-direction: column; justify-content: space-evenly; align-items: center; padding: 10px; text-align: center; }
    .p-eng { font-size: 1.4rem; font-weight: 800; margin: 0; }
    .p-heb { font-size: 1.2rem; color: #64748b; font-weight: 600; }
    .p-caution { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; width: 100%; }
    .p-chip { background: #fef2f2 !important; border: 1px solid #fee2e2; color: #f43f5e; font-size: 0.6rem; font-weight: 800; padding: 4px; border-radius: 4px; -webkit-print-color-adjust: exact; }
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  body { 
    font-family: 'Plus Jakarta Sans', sans-serif; 
    background: var(--bg-gradient); color: var(--primary);
    margin: 0; height: 100vh; display: flex; flex-direction: column;
    overflow: hidden; transition: background 1s ease;
  }

  .hidden { display: none !important; }

  nav {
    padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center;
    backdrop-filter: blur(10px); z-index: 100;
  }

  .logo-area { display: flex; align-items: center; gap: 12px; }
  .logo-mark { 
    background: var(--primary); color: white; 
    width: 32px; height: 32px; border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-weight: 800; font-size: 1rem;
  }
  .logo-text { font-size: 1rem; font-weight: 800; letter-spacing: -0.02em; }

  .nav-tools { display: flex; gap: 8px; }
  .tool-btn { 
    background: var(--glass); border: 1px solid var(--glass-border); 
    padding: 6px 14px; border-radius: 10px; 
    cursor: pointer; font-weight: 600; font-size: 0.8rem; color: var(--primary);
    transition: all 0.2s;
  }

  .main-layout {
    flex: 1; display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    padding: 1rem; position: relative;
  }

  .arena-surface {
    width: 100%; max-width: 1000px;
    display: flex; flex-direction: column; align-items: center; gap: 1.5rem;
  }

  .score-row {
    display: flex; align-items: center; gap: 4rem;
    width: 100%; justify-content: center; position: relative; z-index: 10;
  }

  .team-identity { display: flex; flex-direction: column; align-items: center; gap: 1rem; position: relative; }

  .score-num {
    font-size: 8rem; font-weight: 800; line-height: 0.8;
    letter-spacing: -0.05em; margin: 0; cursor: pointer;
    transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    user-select: none;
  }

  .score-adjuster {
    position: absolute; top: 0; right: -40px;
    display: flex; flex-direction: column; gap: 5px;
    opacity: 0; pointer-events: none; transition: 0.2s;
  }
  .score-adjuster.show { opacity: 1; pointer-events: auto; }
  .adj-btn {
    width: 32px; height: 32px; border-radius: 8px; border: 1px solid #ddd;
    background: white; font-weight: 800; cursor: pointer;
  }

  .team-chip {
    padding: 6px 12px; border-radius: 100px;
    display: flex; align-items: center; gap: 8px;
    background: white; border: 1px solid var(--glass-border);
  }
  .team-chip input[type="color"] {
    appearance: none; border: none; width: 18px; height: 18px; cursor: pointer;
    background: none; border-radius: 50%; padding: 0;
  }
  .team-chip input[type="text"] {
    background: transparent; border: none; font-weight: 800; 
    text-transform: uppercase; text-align: center; outline: none;
    width: 80px; font-size: 0.75rem;
  }

  .mastered-container {
    width: 100%; max-width: 700px;
    display: flex; flex-direction: column; align-items: center; gap: 8px;
  }
  .mastered-header { font-size: 0.6rem; font-weight: 800; color: #94a3b8; letter-spacing: 0.2em; }
  .mastered-list {
    display: flex; flex-wrap: wrap; justify-content: center; 
    gap: 6px; max-height: 80px; overflow-y: auto; width: 100%;
  }
  .mastered-badge {
    padding: 4px 12px; border-radius: 100px; color: white;
    font-size: 0.7rem; font-weight: 800; animation: badgePop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }

  .play-zone { display: flex; flex-direction: column; align-items: center; gap: 1rem; }
  .turn-label { font-size: 0.8rem; font-weight: 800; color: #64748b; letter-spacing: 0.2em; text-transform: uppercase; }
  
  .btn-go {
    width: 110px; height: 110px; border-radius: 50%;
    border: none; cursor: pointer; color: white;
    font-size: 1.3rem; font-weight: 800;
    box-shadow: 0 15px 30px -5px rgba(0,0,0,0.2);
    transition: all 0.3s;
    display: flex; align-items: center; justify-content: center;
    position: relative;
  }

  .card-container {
    position: fixed; inset: 0; display: flex; align-items: center; justify-content: center;
    background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(12px); z-index: 500;
    perspective: 1500px;
  }
  .flip-box {
    width: 95%; max-width: 440px; height: 620px;
    transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    transform-style: preserve-3d; position: relative;
  }
  .flip-box.flipped { transform: rotateY(180deg); }
  .card-face {
    position: absolute; width: 100%; height: 100%;
    backface-visibility: hidden; border-radius: 28px;
    box-shadow: 0 40px 80px -15px rgba(0,0,0,0.5);
    display: flex; flex-direction: column; overflow: hidden;
  }
  .card-front { background: white; transform: rotateY(180deg); }
  .card-back { background: var(--primary); display: flex; align-items: center; justify-content: center; color: white; font-size: 5rem; font-weight: 800; }

  .card-top { padding: 32px 20px; text-align: center; color: white; }
  .card-cat { font-size: 0.55rem; font-weight: 800; letter-spacing: 0.3em; text-transform: uppercase; opacity: 0.9; }
  .card-main-word { font-size: 2.8rem; font-weight: 800; letter-spacing: -0.03em; margin: 8px 0 0 0; }
  
  .card-content { 
    padding: 0 24px; 
    display: flex; 
    flex-direction: column; 
    justify-content: space-evenly; 
    align-items: center; 
    flex: 1; 
  }

  .heb-sub { font-size: 2.2rem; font-weight: 600; color: #64748b; }
  
  .timer-pill {
    background: var(--primary); color: white; padding: 10px 28px;
    border-radius: 100px; font-weight: 800; font-size: 1.2rem; 
    transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; min-width: 100px; justify-content: center;
  }
  .timer-pill.times-up { background: var(--danger); animation: pulse 0.5s infinite alternate; min-width: 180px; }

  .forbidden-section { width: 100%; }
  .caution-header { 
    font-size: 0.65rem; font-weight: 800; color: var(--danger); 
    letter-spacing: 0.25em; text-align: center; margin-bottom: 12px;
    display: flex; align-items: center; justify-content: center; gap: 12px;
  }
  .caution-header::before, .caution-header::after { content: ''; height: 1px; flex: 1; background: #fee2e2; }
  
  .forbidden-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; }
  .forbidden-chip {
    background: #fef2f2; padding: 14px; border-radius: 12px;
    text-align: center; font-weight: 800; color: var(--danger); font-size: 1rem;
    border: 1.5px solid #fee2e2;
  }

  .turn-badge {
    padding: 16px; border-radius: 16px;
    font-size: 0.8rem; font-weight: 800; text-transform: uppercase;
    letter-spacing: 0.15em; width: 100%; text-align: center;
    margin-bottom: 12px;
  }

  .action-bar {
    display: grid; grid-template-columns: 1fr 2fr; gap: 10px;
    padding: 20px; border-top: 1px solid #f1f5f9; background: white;
  }

  .btn { border: none; border-radius: 12px; font-weight: 800; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; }
  .btn-blur { background: #f1f5f9; color: var(--primary); }
  .btn-action { padding: 14px; font-size: 0.85rem; }
  .btn-success { background: var(--success); color: white; }
  .btn-gold { background: var(--gold); color: white; }

  .modal-overlay {
    position: fixed; inset: 0; background: rgba(15, 23, 42, 0.4);
    backdrop-filter: blur(8px); z-index: 1000;
    display: flex; align-items: center; justify-content: center; padding: 20px;
  }
  .modern-modal {
    background: white; width: 100%; max-width: 600px; border-radius: 28px;
    padding: 0; box-shadow: 0 30px 60px rgba(0,0,0,0.2); max-height: 90vh; overflow: hidden;
    display: flex; flex-direction: column;
  }
  
  .modal-tabs {
    display: flex; border-bottom: 1px solid #e2e8f0; background: #f8fafc;
    padding: 12px 24px 0 24px;
  }
  .tab-btn {
    padding: 12px 24px; border: none; background: none; font-weight: 800;
    font-size: 0.75rem; color: #94a3b8; cursor: pointer; position: relative;
    text-transform: uppercase; letter-spacing: 0.05em;
  }
  .tab-btn.active { color: var(--primary); }
  .tab-btn.active::after {
    content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px;
    background: var(--accent); border-radius: 3px 3px 0 0;
  }

  .tab-content { padding: 24px; overflow-y: auto; flex: 1; }

  .setting-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 32px; margin-bottom: 24px; }
  .setting-row { margin-bottom: 20px; }
  .setting-row label { display: block; font-weight: 800; font-size: 0.65rem; color: #94a3b8; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.05em; }

  .label-split { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 8px; }
  .label-split span:last-child { color: var(--accent); font-weight: 800; font-size: 0.8rem; }

  .toggle-btn {
    width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #e2e8f0;
    background: #f8fafc; cursor: pointer; font-weight: 700; font-size: 0.75rem;
    text-align: left; display: flex; justify-content: space-between; align-items: center;
    transition: 0.2s;
  }
  .toggle-btn.active { background: #eff6ff; border-color: #3b82f6; color: #2563eb; }
  .toggle-btn::after { content: 'OFF'; opacity: 0.5; font-size: 0.6rem; }
  .toggle-btn.active::after { content: 'ON'; opacity: 1; }

  .deck-builder { border: 1px solid #e2e8f0; border-radius: 20px; padding: 20px; background: #fafafa; }
  .deck-header-box { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 16px; border-bottom: 1px solid #eee; padding-bottom: 12px; }
  
  .deck-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; max-height: 180px; overflow-y: auto; padding: 2px; }
  .deck-item { 
    padding: 8px; border-radius: 10px; border: 1px solid #e2e8f0; font-size: 0.7rem; 
    font-weight: 700; cursor: pointer; text-align: center; transition: 0.2s; background: white;
  }
  .deck-item.selected { background: var(--primary); color: white; border-color: var(--primary); }

  .input-styled {
    width: 60px; padding: 8px; border-radius: 10px; border: 1px solid #cbd5e1;
    font-weight: 800; font-family: inherit; text-align: center;
  }

  .action-log {
    background: #1e293b; color: #e2e8f0; font-family: monospace; font-size: 0.75rem;
    padding: 16px; border-radius: 16px; height: 300px; overflow-y: auto; line-height: 1.6;
  }
  .log-entry { margin-bottom: 8px; border-bottom: 1px solid #334155; padding-bottom: 4px; }
  .log-time { color: #64748b; margin-right: 8px; }

  @keyframes pulse { to { transform: scale(1.05); } }
  @keyframes badgePop { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
</style>
</head>
<body onload="init()">

<div id="printSection" class="hidden"></div>

<nav>
  <div class="logo-area">
    <div class="logo-mark">M</div>
    <div class="logo-text">MIDDAH MINDREADER</div>
  </div>
  <div class="nav-tools">
    <button class="tool-btn" onclick="openModal('rulesModal')">Rules</button>
    <button class="tool-btn" onclick="openModal('settingsModal')">Settings</button>
  </div>
</nav>

<div class="main-layout">
    <div id="homeArena" class="arena-surface">
        <div class="score-row">
            <div class="team-identity">
                <p id="scoreA" class="score-num" onclick="showAdjuster('A')">0</p>
                <div id="adjA" class="score-adjuster">
                  <button class="adj-btn" onclick="modScore('A', 1)">+</button>
                  <button class="adj-btn" onclick="modScore('A', -1)">-</button>
                </div>
                <div class="team-chip">
                    <input type="color" id="colorA" value="#3b82f6" oninput="saveState(); sync()">
                    <input type="text" id="nameA" value="ALPHA" oninput="saveState(); sync()">
                </div>
            </div>
            <div style="font-weight: 800; color: #cbd5e1; font-size: 1.5rem;">VS</div>
            <div class="team-identity">
                <p id="scoreB" class="score-num" onclick="showAdjuster('B')">0</p>
                <div id="adjB" class="score-adjuster">
                  <button class="adj-btn" onclick="modScore('B', 1)">+</button>
                  <button class="adj-btn" onclick="modScore('B', -1)">-</button>
                </div>
                <div class="team-chip">
                    <input type="color" id="colorB" value="#8b5cf6" oninput="saveState(); sync()">
                    <input type="text" id="nameB" value="OMEGA" oninput="saveState(); sync()">
                </div>
            </div>
        </div>

        <div class="mastered-container">
            <div class="mastered-header">MASTERED MIDDOT</div>
            <div id="masteredList" class="mastered-list"></div>
        </div>

        <div class="play-zone">
            <div id="turnPrompt" class="turn-label">READY?</div>
            <button id="mainBtn" class="btn-go" onclick="handleStart()">
                GO
                <div id="deckCounter" style="position:absolute; bottom:-10px; right:-5px; background:var(--primary); color:white; padding:4px 10px; border-radius:10px; font-size:0.6rem;">0/0</div>
            </button>
            <div style="display:flex; gap:12px; margin-top:1rem;">
                <button onclick="toggleTurn()" class="btn btn-blur" style="padding: 8px 16px; font-size: 0.65rem;">SWITCH TURN</button>
                <div id="pileBtn" onclick="startSecondChance()" style="cursor:pointer; display:flex; align-items:center; gap:8px; background:white; padding:8px 16px; border-radius:100px; border:1px solid var(--glass-border);">
                    <div id="pileCount" style="background:var(--danger); color:white; padding:1px 8px; border-radius:100px; font-weight:800; font-size:0.6rem;">0</div>
                    <div style="font-size:0.6rem; font-weight:800; color:#94a3b8;">SECOND CHANCE</div>
                </div>
            </div>
        </div>
    </div>

    <div id="cardOverlay" class="card-container hidden">
        <div id="flipBox" class="flip-box">
            <div class="card-face card-back">?</div>
            <div class="card-face card-front">
                <div id="cardTop" class="card-top">
                    <div id="cardCat" class="card-cat">CATEGORY</div>
                    <h1 id="mEng" class="card-main-word">Middah</h1>
                </div>
                <div class="card-content">
                    <div id="mHeb" class="heb-sub" dir="rtl">Hebrew</div>
                    
                    <div style="display:flex; align-items:center; gap:12px;">
                        <div class="timer-pill" id="timerDisplay">45</div>
                        <button id="pauseBtn" class="btn btn-blur" style="width:44px; height:44px; border-radius:50%;" onclick="togglePause()">‚è∏</button>
                    </div>

                    <div class="forbidden-section">
                        <div class="caution-header">CAUTION</div>
                        <div class="forbidden-grid" id="tabooGrid"></div>
                    </div>

                    <div id="activeTeamBadge" class="turn-badge">TEAM TURN</div>
                </div>
                <div class="action-bar">
                    <button class="btn btn-blur btn-action" onclick="handleAction('skip')">SKIP</button>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <button class="btn btn-success btn-action" onclick="handleAction('score1')">+1 ENG</button>
                        <button class="btn btn-gold btn-action" onclick="handleAction('score2')">+2 HEB</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="settingsModal" class="modal-overlay hidden">
    <div class="modern-modal">
        <div class="modal-tabs">
            <button id="tabSettings" class="tab-btn active" onclick="switchTab('config')">Configuration</button>
            <button id="tabLog" class="tab-btn" onclick="switchTab('log')">Game Log</button>
        </div>
        
        <div id="tabContentConfig" class="tab-content">
            <div class="setting-grid">
                <div>
                    <div class="setting-row">
                        <label>General Settings</label>
                        <button id="toggleMute" class="toggle-btn" onclick="toggleOption('isMuted')">Mute Sounds</button>
                        <button id="toggleSkip" class="toggle-btn" style="margin-top:8px" onclick="toggleOption('skipCountdown')">Skip Animations</button>
                    </div>
                    <div class="setting-row">
                        <label>Physical Resources</label>
                        <button class="btn btn-blur" style="width:100%; justify-content:space-between; padding:12px; font-size:0.75rem" onclick="exportToPDF()">
                            <span>PDF EXPORT (CARDS)</span>
                            <span style="opacity:0.5; font-size:0.6rem;">üñ®Ô∏è</span>
                        </button>
                    </div>
                </div>
                <div>
                    <div class="setting-row">
                        <label>Game Modes</label>
                        <button id="toggleEasy" class="toggle-btn" onclick="toggleOption('elementaryMode')">Elementary Mode</button>
                    </div>
                    <div class="setting-row">
                        <div class="label-split">
                            <label style="margin:0">Round Timer</label>
                            <span id="timerVal">45s</span>
                        </div>
                        <input type="range" id="timerRange" min="15" max="120" step="5" value="45" style="width:100%" oninput="saveState(); sync()">
                    </div>
                    <div class="setting-row">
                      <div class="label-split">
                        <label style="margin:0">Volume</label>
                        <span id="volVal">30%</span>
                      </div>
                      <input type="range" id="volRange" min="0" max="100" step="5" value="30" style="width:100%" oninput="saveState(); sync()">
                    </div>
                </div>
            </div>

            <div class="deck-builder">
                <div class="deck-header-box">
                    <div>
                        <label style="margin-bottom:4px; display:block">Cards in Play</label>
                        <div style="display:flex; align-items:center; gap:12px">
                            <input type="number" id="deckLimitInput" value="42" min="1" max="42" class="input-styled" onchange="updateDeckLimit()">
                            <span style="font-size:0.65rem; font-weight:700; color:#64748b; line-height:1.2">Select <br>randomly from...</span>
                        </div>
                    </div>
                    <div style="display:flex; gap:6px">
                        <button class="btn btn-blur" style="padding:6px 10px; font-size:0.6rem" onclick="selectAllCards(true)">ALL</button>
                        <button class="btn btn-blur" style="padding:6px 10px; font-size:0.6rem" onclick="selectAllCards(false)">NONE</button>
                    </div>
                </div>
                <div id="deckGrid" class="deck-grid"></div>
            </div>

            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:24px;">
                <button class="btn btn-blur btn-action" onclick="triggerReset(false)">SAME TEAMS RESET</button>
                <button class="btn btn-danger btn-action" style="background:#fee2e2; color:var(--danger)" onclick="triggerReset(true)">FULL NEW GAME</button>
            </div>
        </div>

        <div id="tabContentLog" class="tab-content hidden">
            <div class="action-log-container">
                <div id="actionLog" class="action-log"></div>
                <button class="btn btn-blur btn-action" style="margin-top:12px; width:100%" onclick="clearLog()">Clear Log</button>
            </div>
        </div>

        <div style="padding: 16px 24px 24px 24px;">
            <button class="btn btn-success btn-action" style="width:100%; height:48px;" onclick="closeModal('settingsModal')">SAVE & CLOSE</button>
        </div>
    </div>
</div>

<div id="rulesModal" class="modal-overlay hidden">
    <div class="modern-modal">
        <div style="padding:24px">
            <h2 style="font-weight:800; margin-top:0">Game Rules</h2>
            <p style="font-size:0.9rem; line-height:1.6; color:#475569;">1. Describe the Middah without saying the <b>CAUTION</b> words.<br>2. +1 for the English name.<br>3. +2 if you use the Hebrew name correctly in a sentence!</p>
            <button class="btn btn-success btn-action" style="width:100%; height:48px" onclick="closeModal('rulesModal')">LET'S GO</button>
        </div>
    </div>
</div>

<script>
const RAW_DECK = [
  { e: "Creativity", h: "◊ô÷∞◊¶÷¥◊ô◊®÷∏◊™÷¥◊ô÷º◊ï÷º◊™", cat: "Wisdom", t: ["art", "new", "make", "think"], easy: { e: "Creativity", t: ["art", "new"] } },
  { e: "Opposition", h: "◊û÷∑◊ó÷∞◊ú◊ï÷π◊ß÷∂◊™", cat: "Wisdom", t: ["debate", "argue", "side", "view"], easy: { e: "Arguing", t: ["fight", "sides"] } },
  { e: "Wisdom", h: "◊ó÷∏◊õ÷∞◊û÷∏◊î", cat: "Wisdom", t: ["smart", "brain", "knowledge", "wise"], easy: { e: "Wisdom", t: ["smart", "know"] } },
  { e: "Understanding", h: "◊ë÷¥÷º◊ô◊†÷∏◊î", cat: "Wisdom", t: ["reason", "logic", "explain", "think"], easy: { e: "Knowing Why", t: ["think", "how"] } },
  { e: "Sensibility", h: "◊ì÷∑÷º◊¢÷∑◊™", cat: "Wisdom", t: ["logic", "facts", "common", "sense"], easy: { e: "Common Sense", t: ["real", "facts"] } },
  { e: "Curiosity", h: "◊°÷∑◊ß÷∞◊®÷∏◊†◊ï÷º◊™", cat: "Wisdom", t: ["ask", "why", "wonder", "interest"], easy: { e: "Curiosity", t: ["ask", "why"] } },
  { e: "Foresight", h: "◊®◊ï÷π◊ê÷∂◊î ◊ê÷∂◊™ ◊î÷∑◊†÷º◊ï÷π◊ú÷∏◊ì", cat: "Wisdom", t: ["future", "predict", "next", "see"], easy: { e: "Next Steps", t: ["see", "later"] } },
  { e: "Courage", h: "◊ê◊ï÷π◊û÷∂◊• ◊ú÷µ◊ë", cat: "Courage", t: ["fear", "brave", "strong", "bold"], easy: { e: "Being Brave", t: ["scared", "strong"] } },
  { e: "Integrity", h: "◊ô◊ï÷π◊©÷∂◊Å◊®", cat: "Courage", t: ["truth", "honest", "right", "real"], easy: { e: "Honesty", t: ["truth", "right"] } },
  { e: "Zest & Zeal", h: "◊ñ÷∞◊®÷¥◊ô◊ñ◊ï÷º◊™", cat: "Courage", t: ["fast", "energy", "excited", "quick"], easy: { e: "Energy", t: ["fast", "quick"] } },
  { e: "Conviction", h: "◊ê÷±◊û◊ï÷º◊†÷∏◊î", cat: "Courage", t: ["believe", "sure", "faith", "true"], easy: { e: "Believing", t: ["faith", "sure"] } },
  { e: "Will Power", h: "◊í÷∞÷º◊ë◊ï÷º◊®÷∏◊î", cat: "Courage", t: ["control", "discipline", "strong", "stop"], easy: { e: "Self Control", t: ["stop", "strong"] } },
  { e: "Confidence", h: "◊ë÷¥÷º◊ò÷∏÷º◊ó◊ï÷π◊ü", cat: "Courage", t: ["self", "sure", "proud", "can"], easy: { e: "Feeling Sure", t: ["can", "best"] } },
  { e: "Perseverance", h: "◊†÷∂◊¶÷∑◊ó", cat: "Courage", t: ["grit", "stay", "finish", "keep"], easy: { e: "Not Quitting", t: ["stay", "end"] } },
  { e: "Decency", h: "◊ì÷∂÷º◊®÷∂◊ö÷∞ ◊ê÷∂◊®÷∂◊•", cat: "Honor", t: ["social", "manners", "nice", "people"], easy: { e: "Good Manners", t: ["nice", "please"] } },
  { e: "Compassion", h: "◊®÷∑◊ó÷≤◊û÷¥◊ô◊ù", cat: "Honor", t: ["feel", "pity", "sad", "soft"], easy: { e: "Kind Heart", t: ["feel", "sad"] } },
  { e: "Loyalty", h: "◊†÷∂◊ê÷±◊û÷∏◊†◊ï÷º◊™", cat: "Honor", t: ["true", "stay", "friend", "side"], easy: { e: "Loyalty", t: ["stay", "side"] } },
  { e: "Kindness", h: "◊ó÷∂◊°÷∂◊ì", cat: "Honor", t: ["help", "give", "love", "nice"], easy: { e: "Kindness", t: ["give", "nice"] } },
  { e: "Pursuit of Peace", h: "◊®◊ï÷π◊ì÷µ◊£ ◊©÷∏◊Å◊ú◊ï÷π◊ù", cat: "Honor", t: ["quiet", "stop", "fight", "calm"], easy: { e: "Making Peace", t: ["stop", "fight"] } },
  { e: "Leadership", h: "◊û÷∑◊†÷∞◊î÷¥◊ô◊í◊ï÷º◊™", cat: "Honor", t: ["boss", "lead", "king", "rule"], easy: { e: "Leading", t: ["boss", "front"] } },
  { e: "Justice", h: "◊ì÷¥÷º◊ô◊ü", cat: "Justice", t: ["court", "judge", "law", "right"], easy: { e: "Fairness", t: ["law", "right"] } },
  { e: "Community", h: "◊¢÷≤◊®÷µ◊ë◊ï÷º◊™", cat: "Justice", t: ["group", "all", "responsible", "people"], easy: { e: "Together", t: ["group", "all"] } },
  { e: "Criticism", h: "◊™÷º◊ï÷π◊õ÷µ◊ó÷∏◊î", cat: "Justice", t: ["tell", "wrong", "fix", "advice"], easy: { e: "Fixing Words", t: ["wrong", "tell"] } },
  { e: "Responsibility", h: "◊ê÷∑◊ó÷∞◊®÷∏◊ô◊ï÷º◊™", cat: "Justice", t: ["job", "duty", "task", "owner"], easy: { e: "Responsibility", t: ["duty", "work"] } },
  { e: "Righteous", h: "◊¶÷∂◊ì÷∂◊ß", cat: "Justice", t: ["pure", "holy", "right", "good"], easy: { e: "Being Good", t: ["holy", "right"] } },
  { e: "Patience", h: "◊°÷∑◊ë÷∞◊ú÷∏◊†◊ï÷º◊™", cat: "Moderation", t: ["wait", "slow", "time", "calm"], easy: { e: "Patience", t: ["wait", "slow"] } },
  { e: "Forgiveness", h: "◊û÷∞◊ó÷¥◊ô◊ú÷∏◊î", cat: "Moderation", t: ["sorry", "forget", "pardon", "mad"], easy: { e: "Saying Sorry", t: ["mad", "back"] } },
  { e: "Humility", h: "◊¢÷≤◊†÷∏◊ï÷∏◊î", cat: "Moderation", t: ["small", "proud", "ego", "low"], easy: { e: "Not Boasting", t: ["small", "proud"] } },
  { e: "Modesty", h: "◊¶÷∞◊†÷¥◊ô◊¢◊ï÷º◊™", cat: "Moderation", t: ["quiet", "hidden", "simple", "clothes"], easy: { e: "Modesty", t: ["quiet", "show"] } },
  { e: "Amenability", h: "◊î◊ï÷π◊ì", cat: "Moderation", t: ["agree", "soft", "listen", "kind"], easy: { e: "Getting Along", t: ["agree", "soft"] } },
  { e: "Balance", h: "◊™÷¥÷º◊§÷∞◊ê÷∂◊®÷∂◊™", cat: "Moderation", t: ["middle", "beauty", "equal", "center"], easy: { e: "The Middle", t: ["equal", "half"] } },
  { e: "Order", h: "◊°÷µ◊ì÷∂◊®", cat: "Moderation", t: ["clean", "place", "mess", "organize"], easy: { e: "Neatness", t: ["clean", "mess"] } },
  { e: "Contentment", h: "◊î÷¥◊°÷∞◊™÷∑÷º◊§÷∞÷º◊ß◊ï÷º◊™", cat: "Moderation", t: ["happy", "enough", "satisfied", "want"], easy: { e: "Happy With It", t: ["want", "more"] } },
  { e: "Composure", h: "◊û÷∞◊†◊ï÷º◊ó÷∑◊™ ◊î÷∑◊†÷∂÷º◊§÷∂◊©◊Å", cat: "Moderation", t: ["calm", "soul", "quiet", "relax"], easy: { e: "Calm Mind", t: ["quiet", "rest"] } },
  { e: "Wonder", h: "◊û÷∑◊ú÷∞◊õ◊ï÷º◊™", cat: "Transcendence", t: ["wow", "king", "big", "world"], easy: { e: "Wonder", t: ["wow", "big"] } },
  { e: "Wholeness", h: "◊©÷∞◊Å◊ú÷µ◊û◊ï÷º◊™", cat: "Transcendence", t: ["peace", "full", "one", "complete"], easy: { e: "All Full", t: ["full", "one"] } },
  { e: "Reverence", h: "◊ô÷¥◊®÷∞◊ê÷∏◊î", cat: "Transcendence", t: ["awe", "fear", "god", "respect"], easy: { e: "Great Respect", t: ["awe", "god"] } },
  { e: "Love", h: "◊ê÷∑◊î÷≤◊ë÷∏◊î", cat: "Transcendence", t: ["heart", "care", "family", "feeling"], easy: { e: "Love", t: ["heart", "care"] } },
  { e: "Joy", h: "◊©÷¥◊Ç◊û÷∞◊ó÷∏◊î", cat: "Transcendence", t: ["happy", "laugh", "smile", "fun"], easy: { e: "Joy", t: ["fun", "laugh"] } },
  { e: "Gratitude", h: "◊î÷∑◊õ÷∏÷º◊®÷∑◊™ ◊î÷∑◊ò÷º◊ï÷π◊ë", cat: "Transcendence", t: ["thank", "good", "see", "gift"], easy: { e: "Thankfulness", t: ["thank", "gift"] } },
  { e: "Groundedness", h: "◊ô÷∞◊°◊ï÷π◊ì", cat: "Transcendence", t: ["base", "earth", "strong", "deep"], easy: { e: "Being Steady", t: ["base", "deep"] } },
  { e: "Truth", h: "◊ê÷±◊û÷∂◊™", cat: "Wisdom", t: ["real", "honest", "fact", "true"], easy: { e: "Truth", t: ["real", "true"] } }
];

const CAT_COLORS = { 
    Wisdom: "#3b82f6", Courage: "#ef4444", Honor: "#f59e0b", 
    Justice: "#6366f1", Moderation: "#10b981", Transcendence: "#8b5cf6" 
};

let state = {
  scoreA: 0, scoreB: 0, currentTeam: 'A',
  used: [], skips: [], mastered: [], 
  elementaryMode: false, isMuted: false, skipCountdown: false,
  availableIndices: RAW_DECK.map((_, i) => i),
  deckLimit: 42,
  activeDeck: [],
  baseTimer: 45,
  volLevel: 30
};

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playSound(freq, type = 'sine', duration = 0.1, volumeMult = 1) {
    if (state.isMuted) return;
    const masterVol = (state.volLevel || 30) / 100;
    const osc = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    g.gain.setValueAtTime(0.1 * volumeMult * masterVol, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
    osc.connect(g); g.connect(audioCtx.destination);
    osc.start(); osc.stop(audioCtx.currentTime + duration);
}

function init() {
    loadState();
    buildDeckUI();
    sync();
}

function log(msg) {
    const el = document.getElementById('actionLog');
    if (!el) return;
    const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    el.innerHTML = `<div class="log-entry"><span class="log-time">${time}</span> ${msg}</div>` + el.innerHTML;
}

function clearLog() {
    document.getElementById('actionLog').innerHTML = '';
    log("Log cleared.");
}

function switchTab(tab) {
    document.getElementById('tabSettings').classList.toggle('active', tab === 'config');
    document.getElementById('tabLog').classList.toggle('active', tab === 'log');
    document.getElementById('tabContentConfig').classList.toggle('hidden', tab !== 'config');
    document.getElementById('tabContentLog').classList.toggle('hidden', tab !== 'log');
}

function buildDeckUI() {
    const grid = document.getElementById('deckGrid');
    if (!grid) return;
    grid.innerHTML = RAW_DECK.map((c, i) => {
        const displayName = state.elementaryMode ? c.easy.e : c.e;
        return `
            <div id="deck-item-${i}" class="deck-item ${state.availableIndices.includes(i) ? 'selected' : ''}" onclick="toggleCardSelection(${i})">
                ${displayName}
            </div>
        `;
    }).join('');
}

function toggleCardSelection(idx) {
    if (state.availableIndices.includes(idx)) {
        state.availableIndices = state.availableIndices.filter(i => i !== idx);
    } else {
        state.availableIndices.push(idx);
    }
    if (state.deckLimit > state.availableIndices.length) {
        state.deckLimit = Math.max(1, state.availableIndices.length);
        const limitInp = document.getElementById('deckLimitInput');
        if (limitInp) limitInp.value = state.deckLimit;
    }
    const item = document.getElementById(`deck-item-${idx}`);
    if (item) item.classList.toggle('selected');
    saveState();
    generateActiveDeck();
}

function selectAllCards(val) {
    state.availableIndices = val ? RAW_DECK.map((_, i) => i) : [];
    state.deckLimit = val ? 42 : 0;
    const limitInp = document.getElementById('deckLimitInput');
    if (limitInp) limitInp.value = state.deckLimit;
    buildDeckUI();
    saveState();
    generateActiveDeck();
}

function updateDeckLimit() {
    const limitInp = document.getElementById('deckLimitInput');
    if (!limitInp) return;
    let val = parseInt(limitInp.value);
    if (val > state.availableIndices.length) val = state.availableIndices.length;
    if (val < 1) val = 1;
    state.deckLimit = val;
    limitInp.value = val;
    saveState();
    generateActiveDeck();
}

function generateActiveDeck() {
    const pool = [...state.availableIndices];
    const shuffled = pool.sort(() => 0.5 - Math.random());
    state.activeDeck = shuffled.slice(0, state.deckLimit);
    state.used = [];
    sync();
}

function toggleOption(key) {
    state[key] = !state[key];
    if (key === 'elementaryMode') {
        buildDeckUI(); 
        log(`Switched to ${state[key] ? 'Elementary' : 'Standard'} Mode`);
    } else {
        log(`Toggled ${key} to ${state[key]}`);
    }
    saveState();
    sync();
}

function saveState() {
    const nA = document.getElementById('nameA');
    const nB = document.getElementById('nameB');
    const cA = document.getElementById('colorA');
    const cB = document.getElementById('colorB');
    const tR = document.getElementById('timerRange');
    const vR = document.getElementById('volRange');

    if (nA) state.teamAName = nA.value;
    if (nB) state.teamBName = nB.value;
    if (cA) state.teamAColor = cA.value;
    if (cB) state.teamBColor = cB.value;
    if (tR) state.baseTimer = parseInt(tR.value);
    if (vR) state.volLevel = parseInt(vR.value);
    
    localStorage.setItem('middah_v3_5_fixed', JSON.stringify(state));
}

function loadState() {
    const saved = localStorage.getItem('middah_v3_5_fixed');
    if (saved) {
        const parsed = JSON.parse(saved);
        state = { ...state, ...parsed };
        
        const nA = document.getElementById('nameA');
        const nB = document.getElementById('nameB');
        const cA = document.getElementById('colorA');
        const cB = document.getElementById('colorB');
        const tR = document.getElementById('timerRange');
        const vR = document.getElementById('volRange');
        const dL = document.getElementById('deckLimitInput');

        if (nA) nA.value = state.teamAName || "ALPHA";
        if (nB) nB.value = state.teamBName || "OMEGA";
        if (cA) cA.value = state.teamAColor || "#3b82f6";
        if (cB) cB.value = state.teamBColor || "#8b5cf6";
        if (tR) tR.value = state.baseTimer || 45;
        if (vR) vR.value = state.volLevel || 30;
        if (dL) dL.value = state.deckLimit || 42;
    }
    if (!state.activeDeck || state.activeDeck.length === 0) generateActiveDeck();
}

function sync() {
    const colorA = document.getElementById('colorA')?.value || "#3b82f6";
    const colorB = document.getElementById('colorB')?.value || "#8b5cf6";
    const nameA = document.getElementById('nameA')?.value || "ALPHA";
    const nameB = document.getElementById('nameB')?.value || "OMEGA";
    
    const sA = document.getElementById('scoreA');
    const sB = document.getElementById('scoreB');
    if (sA) { sA.innerText = state.scoreA; sA.style.color = colorA; }
    if (sB) { sB.innerText = state.scoreB; sB.style.color = colorB; }
    
    const activeColor = state.currentTeam === 'A' ? colorA : colorB;
    const activeName = state.currentTeam === 'A' ? nameA : nameB;
    
    const prompt = document.getElementById('turnPrompt');
    if (prompt) prompt.innerText = `READY ${activeName}?`;
    
    const mBtn = document.getElementById('mainBtn');
    if (mBtn) mBtn.style.background = activeColor;
    
    const badge = document.getElementById('activeTeamBadge');
    if (badge) {
        badge.innerText = `${activeName}'S TURN`;
        badge.style.color = activeColor;
        badge.style.background = activeColor + '15';
    }

    document.body.style.background = `linear-gradient(135deg, #f8fafc 0%, ${activeColor}15 100%)`;
    
    const pC = document.getElementById('pileCount');
    if (pC) pC.innerText = state.skips.length;
    
    const dC = document.getElementById('deckCounter');
    if (dC) dC.innerText = `${state.used.length}/${state.activeDeck.length}`;
    
    const mastered = document.getElementById('masteredList');
    if (mastered) {
        mastered.innerHTML = state.mastered.map(m => {
            const name = state.elementaryMode ? m.easy : m.e;
            return `<div class="mastered-badge" style="background:${CAT_COLORS[m.cat] || '#333'}">${name}</div>`;
        }).join('');
    }
    
    const tV = document.getElementById('timerVal');
    const tR = document.getElementById('timerRange');
    if (tV && tR) tV.innerText = tR.value + 's';
    
    const vV = document.getElementById('volVal');
    const vR = document.getElementById('volRange');
    if (vV && vR) vV.innerText = vR.value + '%';

    const tM = document.getElementById('toggleMute');
    if (tM) tM.classList.toggle('active', state.isMuted);
    const tS = document.getElementById('toggleSkip');
    if (tS) tS.classList.toggle('active', state.skipCountdown);
    const tE = document.getElementById('toggleEasy');
    if (tE) tE.classList.toggle('active', state.elementaryMode);
}

function handleStart() {
    const pool = state.activeDeck.filter(idx => !state.used.includes(idx));
    if (pool.length === 0) {
        if (state.skips.length > 0) startSecondChance();
        else {
            log("Game Finished!");
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        }
        return;
    }
    const idx = pool[Math.floor(Math.random() * pool.length)];
    state.currentCard = RAW_DECK[idx];
    state.used.push(idx);
    presentCard(state.currentCard);
}

function startSecondChance() {
    if (state.skips.length === 0) return;
    state.currentCard = state.skips.shift();
    log(`Second chance: ${state.currentCard.e}`);
    presentCard(state.currentCard);
}

function presentCard(card) {
    if (!card) return;
    const top = document.getElementById('cardTop');
    const cat = document.getElementById('cardCat');
    const eng = document.getElementById('mEng');
    const heb = document.getElementById('mHeb');
    const grid = document.getElementById('tabooGrid');

    if (top) top.style.background = CAT_COLORS[card.cat];
    if (cat) cat.innerText = card.cat;
    if (eng) eng.innerText = state.elementaryMode ? card.easy.e : card.e;
    if (heb) heb.innerText = card.h;
    
    const displayTaboo = state.elementaryMode ? card.easy.t : card.t;
    if (grid) grid.innerHTML = displayTaboo.map(w => `<div class="forbidden-chip">${w}</div>`).join('');
    
    openModal('cardOverlay');
    const fb = document.getElementById('flipBox');
    fb.classList.remove('flipped');
    
    if (state.skipCountdown) {
        fb.classList.add('flipped');
        startTimer();
    } else {
        setTimeout(() => {
            fb.classList.add('flipped');
            playSound(440, 'sine', 0.2);
            startTimer();
        }, 800);
    }
}

let gameInterval;
function startTimer() {
    state.timer = state.baseTimer || 45;
    state.paused = false;
    updateTimerUI();
    if (gameInterval) clearInterval(gameInterval);
    gameInterval = setInterval(() => {
        if (state.paused) return;
        state.timer--;
        if (state.timer <= 5 && state.timer > 0) playSound(880, 'square', 0.05, 0.5);
        updateTimerUI();
        if (state.timer <= 0) {
            clearInterval(gameInterval);
            playSound(110, 'sawtooth', 0.6, 1);
            const disp = document.getElementById('timerDisplay');
            if (disp) {
                disp.innerText = "TIMES UP!";
                disp.classList.add('times-up');
            }
        }
    }, 1000);
}

function updateTimerUI() {
    const el = document.getElementById('timerDisplay');
    if (!el) return;
    el.innerText = state.timer;
    el.classList.toggle('warning', state.timer <= 5);
    el.classList.remove('times-up');
}

function togglePause() {
    state.paused = !state.paused;
    const btn = document.getElementById('pauseBtn');
    if (btn) btn.innerText = state.paused ? "‚ñ∂" : "‚è∏";
}

function handleAction(type) {
    if (gameInterval) clearInterval(gameInterval);
    const nameA = document.getElementById('nameA')?.value || "ALPHA";
    const nameB = document.getElementById('nameB')?.value || "OMEGA";
    const activeTeam = state.currentTeam === 'A' ? nameA : nameB;
    const colorId = 'color' + state.currentTeam;
    const activeColor = document.getElementById(colorId)?.value || "#3b82f6";

    if (type === 'score1') {
        state[`score${state.currentTeam}`] += 1;
        state.mastered.push({ e: state.currentCard.e, easy: state.currentCard.easy.e, cat: state.currentCard.cat });
        log(`${activeTeam} +1 for ${state.currentCard.e}`);
        playSound(523, 'sine', 0.2);
        confetti({ particleCount: 35, spread: 60, origin: { y: 0.8 }, colors: [activeColor] });
    } else if (type === 'score2') {
        state[`score${state.currentTeam}`] += 2;
        state.mastered.push({ e: state.currentCard.e, easy: state.currentCard.easy.e, cat: state.currentCard.cat });
        log(`${activeTeam} +2 (Hebrew) for ${state.currentCard.e}`);
        playSound(659, 'sine', 0.3);
        confetti({ particleCount: 75, spread: 90, origin: { y: 0.7 } });
    } else {
        state.skips.push(state.currentCard);
        log(`${activeTeam} skipped ${state.currentCard.e}`);
        playSound(330, 'sine', 0.2);
    }
    closeModal('cardOverlay');
    toggleTurn();
    saveState();
}

function triggerReset(isFull) {
    if (isFull) {
        state = { scoreA: 0, scoreB: 0, currentTeam: 'A', used: [], skips: [], mastered: [], availableIndices: RAW_DECK.map((_, i) => i), deckLimit: 42, baseTimer: 45, volLevel: 30 };
        localStorage.removeItem('middah_v3_5_fixed');
        location.reload();
    } else {
        state.used = []; state.skips = []; state.mastered = []; state.scoreA = 0; state.scoreB = 0; state.currentTeam = 'A';
        generateActiveDeck();
        saveState();
        sync();
        closeModal('settingsModal');
    }
}

function toggleTurn() {
    state.currentTeam = state.currentTeam === 'A' ? 'B' : 'A';
    sync();
}

function showAdjuster(t) {
    document.querySelectorAll('.score-adjuster').forEach(a => a.classList.remove('show'));
    document.getElementById(`adj${t}`).classList.add('show');
}

function modScore(t, v) {
    state[`score${t}`] += v;
    saveState();
    sync();
}

function exportToPDF() {
    const printArea = document.getElementById('printSection');
    printArea.innerHTML = '';
    const sortedDeck = [...RAW_DECK].sort((a,b) => a.cat.localeCompare(b.cat));

    sortedDeck.forEach(card => {
        const engName = state.elementaryMode ? card.easy.e : card.e;
        const cautionWords = state.elementaryMode ? card.easy.t : card.t;
        const cardHtml = `
            <div class="printable-card">
                <div class="p-header" style="background:${CAT_COLORS[card.cat]}">${card.cat.toUpperCase()}</div>
                <div class="p-body">
                    <h2 class="p-eng">${engName}</h2>
                    <div class="p-heb" dir="rtl">${card.h}</div>
                    <div class="p-caution">
                        ${cautionWords.map(w => `<div class="p-chip">${w}</div>`).join('')}
                    </div>
                </div>
            </div>
        `;
        printArea.innerHTML += cardHtml;
    });

    log(`PDF export triggered (${state.elementaryMode ? 'Elementary' : 'Standard'}).`);
    window.print();
}

function openModal(id) { 
    const el = document.getElementById(id);
    if (el) el.classList.remove('hidden'); 
}

function closeModal(id) { 
    const el = document.getElementById(id);
    if (el) el.classList.add('hidden'); 
    if (id === 'cardOverlay' && gameInterval) clearInterval(gameInterval);
}
</script>
</body>
</html>